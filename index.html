<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Chat component</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script defer src="./dist/polyfill.min.js"></script>

    <script>if (window.ShadowRoot) { document.write('<!--'); }</script>
    <script defer type="text/javascript" src="./public/node_modules/@webcomponents/webcomponentsjs/webcomponents-bundle.js"></script>
    <!--! do not remove -->

    <script>if (!window.customElements) { document.write('<!--'); }</script>
    <script defer type="text/javascript" src="./public/node_modules/@webcomponents/webcomponentsjs/custom-elements-es5-adapter.js"></script>
    <!--! do not remove -->

    <link href="./public/fonts.css" rel="stylesheet" />

    <script defer src="./dist/chat.min.js"></script>

    <script>
      var _messages = [
        {
          name: 'Admin',
          user_name: "Admin",
          role: 'moderator',
          user_role: 'moderator',
          identity: 'Administrator',
          user_id: 99,
          visible: true,
          avatar: 'https://about.gitlab.com/images/comparison/gitlab-logo.svg',
          id: Date.now(),
          body: 'Hello World!',
          timestamp: Date.now() / 1e3,
          rating: 100500,
        }
      ]
      var _users = [
        {
          name: 'Marco Polo',
          identity: 'me',
          user_name: "Marco Polo",
          user_role: 'user',
          user_id: 1,
          visible: true,
          avatar: 'https://about.gitlab.com/images/comparison/gitlab-logo.svg'
        },
      ]

      var _actions = [['message-delete', { self: true }],['message-reaction', { self: true }]]

      var _actionsallowed = ['message-delete', 'user-disable', 'message-reaction']

      function enhanceMessage (message) {
        const _message = {
          id: Date.now(),
          body: message,
          timestamp: Date.now() / 1e3,
          user_id: 1,
        }

        return Object.assign(_message, _users.filter(function(_){
          return _.user_id === _message.user_id
        })[0] || {})
      }

      function initialize () {
        var messenger = document.getElementById('messenger')
        var reverse = ~location.search.indexOf('reverse=true') ? true : false

        messenger.actions = _actions
        messenger.actionsallowed = _actionsallowed
        messenger.list = _messages
        messenger.users = _users
        messenger.user = 1

        messenger.addEventListener('chat-message-submit', function(e) {
          setTimeout(function() {
            if(reverse){
              _messages = [enhanceMessage(e.detail.message)].concat(_messages)
            }else{
              _messages = _messages.concat(enhanceMessage(e.detail.message))
            }

            messenger.list = _messages
          }, 1e2)
        })

        messenger.addEventListener('chat-message-reaction', function(e) {
          _messages = _messages.map(function(it) {
            if(it.id === e.detail.message.id) it.rating = !it.rating ? 1 : it.rating + 1
            return it
          })

          messenger.list = _messages
        })

        messenger.addEventListener('chat-message-delete', function(e) {
          alert('Delete message: ' + JSON.stringify(e.detail))
        })

        messenger.addEventListener('chat-user-disable', function(e) {
          alert('Disable user: '+ JSON.stringify(e.detail))
        })
      }

      window.addEventListener('DOMContentLoaded', function() {
        var _Chat = window.WCChat.chat.default

        window.customElements.define('wc-chat', _Chat)

        initialize()
      })
    </script>
    <style>
      html,
      body {
        height: 100%;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <h1>Chat</h1>
    <div style="height:500px; width: 30%;">
      <wc-chat
        id="messenger"
        placeholder="Write somethingâ€¦"
        placeholderdisabled="Chat is blocked now"
      />
    </div>
  </body>
</html>
