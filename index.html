<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Chat component</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script async src="https://cdn.jsdelivr.net/npm/ulid@2.3.0/dist/index.umd.min.js"></script>
  <script async src="https://cdn.jsdelivr.net/npm/core-js@2.6.5/client/shim.min.js"></script>
  <script async src="https://cdn.jsdelivr.net/npm/markdown-it@8.4.2/dist/markdown-it.min.js"></script>
  <script async src="https://cdn.jsdelivr.net/npm/intl-messageformat@2.2.0/dist/intl-messageformat-with-locales.min.js"></script>

  <script async type="module" src="./index.js"></script>
  <script async type="module" src="./src/input.index.js"></script>
  <script async type="module" src="./src/message.index.js"></script>
  <script async type="module" src="./src/messages-extended.index.js"></script>
  <script async type="module" src="./src/reactions.index.js"></script>
  <script async type="module" src="./src/scrollable-unseen.index.js"></script>
  <script async type="module" src="./src/chat-i18n.index.js"></script>
  <script async type="module">
    const elements = [messenger1, messenger2, messenger3]

    var avatarUrl = 'https://about.gitlab.com/images/devops-tools/gitlab-logo.svg'

    var _messages = [
      {
        avatar: avatarUrl,
        body: 'Hello World!',
        icon: 'man',
        id: window.ULID.ulid(),
        identity: (function getIdentity (user_role = 'moderator') { return 'Administrator' }()), // eslint-disable-line no-unused-vars
        rating: 0 || [['thumbsup', 0]],
        theme: 'red',
        timestamp: Date.now() / 1e3,
        user_id: 3,
        user_name: 'Alan Mathison Turing',
        visible: true,
      },
    ]

    var _users = [
      {
        avatar: avatarUrl,
        identity: 'me',
        user_id: 1,
        user_name: 'Marco Polo',
        visible: true,
      },
      {
        avatar: avatarUrl,
        identity: 'me2',
        user_id: 2,
        user_name: 'Mario',
        visible: true,
      },
      {
        avatar: avatarUrl,
        identity: (function getIdentity (user_role = 'moderator') { return 'Administrator' }()), // eslint-disable-line no-unused-vars
        user_id: 3,
        user_name: 'Alan Mathison Turing',
        visible: true,
      },
    ]

    function enhanceMessage (message, userId) {
      var _message = {
        id: window.ULID.ulid(),
        body: message,
        timestamp: Date.now() / 1e3,
        user_id: userId,
      }

      if (userId === 3) {
        _message.theme = 'red'
        _message.icon = 'man'
      }

      return Object.assign(_message, _users.filter(function selectUsers (_) {
        return _.user_id === _message.user_id
      })[0] || {})
    }

    function messageFactory () {
      var index = Math.round(Math.random() * 2)

      return enhanceMessage(Math.random().toString(36).substring(7), index + 1)
    }

    function update (list, messages) {
      list.forEach((_) => {
        _ && _.updateList(messages)

        window._messages = messages
      })
    }

    function initialize(element, user, makeUpdate){
      element.users = _users
      element.user = user

      if (element === messenger3) {
        // means user is admin and stuff
        element.actions = [['user-disable', 11], ['message-delete', 111], ['message-reaction', 1]]
        element.reactions = [['thumbsup']]
      } else {
        element.actions = [['user-disable', 0], ['message-delete', 100], ['message-reaction', 1]]
        element.reactions = [['thumbsup']]
      }

      _messages.length && element.updateList(_messages)

      element.addEventListener('chat-message-submit', function onMessageSubmit (e) {
        setTimeout(function onSubmitSuccess () {
          _messages = _messages.concat(enhanceMessage(e.detail.message, user))

          makeUpdate(_messages)
        }, 1e2)
      })

      element.addEventListener('chat-message-reaction', function onMessageReaction (e) {
        _messages = _messages.map(function calcRating (it) {
          if (it.id
          && e.detail.message.id
          && it.id === e.detail.message.id
          ) {
            if (Array.isArray(it.rating)) {
              it.rating = [['thumbsup', (it.rating[0][1] || 0) + 1]]
            } else if (typeof it.rating === 'number') {
              it.rating = !it.rating ? 1 : it.rating + 1
            } else {
              it.rating = [['thumbsup', 1]]
            }
          }

          return it
        })

        makeUpdate(_messages)
      })

      element.addEventListener('chat-message-delete', function onMessageDelete (e) {
        alert(`Delete message: ${JSON.stringify(e.detail)}`) // eslint-disable-line no-alert
      })

      element.addEventListener('chat-user-disable', function onUserDisable (e) {
        alert(`Disable user: ${JSON.stringify(e.detail)}`) // eslint-disable-line no-alert
      })

      element.addEventListener('chat-last-seen-change', function onLastSeenChange (e) {
        element.lastseen = e.detail
      })

      element.lastseen = _messages && _messages.length ? _messages[_messages.length - 1].id : undefined
    }

    initialize(messenger1, 1, list => update(elements, list))
    initialize(messenger2, 2, list => update(elements, list))
    initialize(messenger3, 3, list => update(elements, list))

    import { emitter } from './util/message-emitter.js'

    window.__WcChatEmitter = emitter(() => {
      _messages = _messages.concat(messageFactory());

      ((list) => { update(elements, list) })(_messages)
    })

    messenger1.I18nEngine = globalThis.IntlMessageFormat
    messenger1.ParserEngine = globalThis.markdownit

    messenger2.I18nEngine = globalThis.IntlMessageFormat
    messenger2.ParserEngine = globalThis.markdownit

    messenger3.I18nEngine = globalThis.IntlMessageFormat

    </script>
  </head>
  <body>
    <h1>Chat</h1>
    <div class="row">
      <div class="container">
        <wc-chat
          delayresize=400
          delayupdate=200
          id="messenger1"
          language="ru"
          parser="markdown"
          parserpreset="strict"
          placeholder="Введите сообщение"
          placeholderdisabled="Чат заблокирован"
          />
        </div>
        <div class="container">
          <wc-chat
          delayresize=400
          delayupdate=200
          id="messenger2"
          language="en-US"
          parser="html-entities"
          placeholder="Write something…"
          placeholderdisabled="Chat is blocked now"
        />
      </div>
      <div class="container">
        <wc-chat
          delayresize=400
          delayupdate=200
          id="messenger3"
          language="en-US"
          placeholder="Write something…"
          placeholderdisabled="Chat is blocked now"
          scrollabledisabled
        />
      </div>
    </div>
    <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
    <style>
      body {
        font-family: "Lato", sans-serif;
      }

      .container {
        display: inline-block;
        height: 450px;
        margin-bottom: 3px;
        position: relative;
        vertical-align: top;
        width: 280px;
      }

      @media (max-width: 600px) {
        .container {
          width: 550px;
        }
      }

      #messenger1,
      #messenger2,
      #messenger3 {
        width: inherit;
      }
      </style>
  </body>
</html>
